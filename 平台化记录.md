# 项目功能平台化
基础应用能力（增删改查）
应用管理
应用生成
应用部署（3种方案）
前端页面生成和优化

# 方案设计
平台化改造的核心在于建立完整的应用生命周期管理体系。
用户在主页输入提示词后，系统会创建一个应用记录，然后跳转到对话页面与AI交互生成网站。生成完成后，用户可以 预览效果，满意后进行部署，让网站真正对外提供服务。
这个流程看似简单，但涉及到数据存储、权限控制、文件管理、网站部署等多个技术环节。我们需要设计合理的数据模型 来支撑这些功能。

# 库表设计
```MySQL
-- 应用表
create table if not exists app
(
    id           bigint auto_increment comment 'id' primary key,
    appName      varchar(256)                       null comment '应用名称',
    cover        varchar(512)                       null comment '应用封面',
    initPrompt   text                               null comment '应用初始化的 prompt',
    codeGenType  varchar(64)                        null comment '代码生成类型（枚举）',
    deployKey    varchar(64)                        null comment '部署标识',
    deployedTime datetime                           null comment '部署时间',
    priority     int      default 0                 not null comment '优先级',
    userId       bigint                             not null comment '创建用户id',
    isVipOnly    tinyint  default 0                 null comment '是否为VIP专属应用（0-否，1-是）',
    editTime     datetime default CURRENT_TIMESTAMP not null comment '编辑时间',
    createTime   datetime default CURRENT_TIMESTAMP not null comment '创建时间',
    updateTime   datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment '更新时间',
    isDelete     tinyint  default 0                 not null comment '是否删除',
    UNIQUE KEY uk_deployKey (deployKey), -- 确保部署标识唯一
    INDEX idx_appName (appName),         -- 提升基于应用名称的查询性能
    INDEX idx_userId (userId),           -- 提升基于用户 ID 的查询性能
    INDEX idx_isVipOnly (isVipOnly)      -- 提升基于VIP专属的查询性能
) comment '应用' collate = utf8mb4_unicode_ci;

```
1)priority优先级字段：我们约定99表示精选应用，这样可以在主页展示高质量的应用，避免用户看到大量测试内 容。
为什么用数字而不用枚举类型呢？原因是这样更利于扩展，比如约定999表示置顶；还可以根据数字灵活调整各个应用的具体展示顺序。
2)添加索引:给deployKey、appName、userld三个经常用于作为查询条件的字段增加索引，提高查询性能。
注意，我们暂时不考虑将应用代码直接保存到数据库字段中，而是保存在文件系统里。这样可以避免数据库和文件存储不 一致的问题，也便于后续扩展到对象存储等方案。

# 基础应用能力
```aiignore
请参考项目中已有的 User 模块的文件和代码风格，帮我根据下列需求，生成完整的 App 模块的代码。

需要的功能如下：
-【用户】创建应用（须填写 initPrompt）
-【用户】根据 id 修改自己的应用（目前只支持修改应用名称）
-【用户】根据 id 删除自己的应用
-【用户】根据 id 查看应用详情
-【用户】分页查询自己的应用列表（支持根据名称查询，每页最多 20 个）
-【用户】分页查询精选的应用列表（支持根据名称查询，每页最多 20 个）
-【管理员】根据 id 删除任意应用
-【管理员】根据 id 更新任意应用（支持更新应用名称、应用封面、优先级）
-【管理员】分页查询应用列表（支持根据除时间外的任何字段查询，每页数量不限）
-【管理员】根据 id 查看应用详情

```
添加定时任务来判断用户的vip状态

# 应用生成
为生成内容补充appId参数并且使其同步

# sse流式接口开发
curl测试
```aiignore
# 1. 用户登录
curl -X POST "http://localhost:8234/api/user/login" \
  -H "Content-Type: application/json" \
  -d '{
    "userAccount": "admin114",
    "userPassword": "1234567890"
  }' \
  -c cookies.txt

# 2. 调用生成代码接口（流式）
curl -G "http://localhost:8234/api/app/chat/gen/code" \
  --data-urlencode "appId=309815103136477184" \
  --data-urlencode "message=做一个哈基米博客，总代码行数不超过20" \
  -H "Accept: text/event-stream" \
  -H "Cache-Control: no-cache" \
  -b cookies.txt \
  --no-buffer

```
```aiignore
curl ^"http://localhost:8234/api/app/add^" ^
  -H ^"Accept: */*^" ^
  -H ^"Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6^" ^
  -H ^"Cache-Control: no-cache^" ^
  -H ^"Connection: keep-alive^" ^
  -H ^"Content-Type: application/json^" ^
  -b ^"JSESSIONID=198CEDFB91D9EDDFFE8F3450EE1A31C9; locale=zh-Hans; custom_session_names=^{^%^221753853312110wy66l39jl^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^22^%^2C^%^221753853328482kibt35h2s^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^22^%^2C^%^221753855280812xaoc45yxx^%^22:^%^22^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^22^%^2C^%^221753858785620ldykhoq98^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^22^%^2C^%^221753858963871coucgomny^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E5^%^8F^%^AE^%^E5^%^92^%^9A^%^E9^%^B8^%^A1^%^22^%^2C^%^221753859216542llwrmlax7^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^22^%^2C^%^221753859253689t5l0ry2ac^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E6^%^9B^%^BC^%^E6^%^B3^%^A2^%^20^%^E4^%^BD^%^A0^%^E7^%^9F^%^A5^%^E9^%^81^%^93^%^E5^%^8F^%^AE^%^E5^%^92^%^9A^%^E9^%^B8^%^A1^%^E5^%^90^%^97^%^22^%^2C^%^221753859343670ycrcaaw6s^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^9B^%^BC^%^E6^%^B3^%^A2^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^22^%^2C^%^221753859733181rs2qnbea0^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^E6^%^9B^%^BC^%^E6^%^B3^%^A2^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^22^%^2C^%^221753860175244oqkeztfhq^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E5^%^8F^%^AE^%^E5^%^92^%^9A^%^E9^%^B8^%^A1^%^22^%^2C^%^221753924435714pv3ahradn^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E4^%^BD^%^A0^%^E7^%^9F^%^A5^%^E9^%^81^%^93^%^E5^%^8F^%^AE^%^E5^%^92^%^9A^%^E9^%^B8^%^A1^%^E5^%^90^%^97^%^22^%^2C^%^221753924570142xlg776j3z^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E4^%^BD^%^A0^%^E7^%^9F^%^A5^%^E9^%^81^%^93^%^E5^%^8F^%^AE^%^E5^%^92^%^9A^%^E9^%^B8^%^A1^%^E5^%^90^%^97^%^22^%^2C^%^221753924966293jzifp5r08^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^22^%^2C^%^221753925204096mm8nrt6t1^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E4^%^B8^%^81^%^E7^%^9C^%^9F^%^22^%^2C^%^221753925369810ub8df5db9^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E5^%^A4^%^A7^%^E7^%^8B^%^97^%^E5^%^8F^%^AB^%^22^%^2C^%^221753925534483ix4050c5a^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^22^%^2C^%^221753925930301kzk7th8li^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^22^%^2C^%^221753926190816061g39tir^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E4^%^B8^%^81^%^E7^%^9C^%^9F^%^22^%^2C^%^221753927256829a7vou20j4^%^22:^%^221^%^22^%^2C^%^221753927431304wn0rfhjom^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E5^%^8F^%^AE^%^E5^%^92^%^9A^%^E9^%^B8^%^A1^%^22^%^2C^%^221753927949187fhuqpy3pc^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^A5^%^BD^%^20^%^E6^%^88^%^91^%^E6^%^98^%^AF^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^22^%^2C^%^221753930601773jnatlpgn2^%^22:^%^22^%^E6^%^88^%^91^%^E8^%^A6^%^81^%^E6^%^8E^%^A8^%^E7^%^BF^%^BB^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^22^%^2C^%^2217539306553416ucossoec^%^22:^%^22^%^E6^%^88^%^91^%^E8^%^A6^%^81^%^E6^%^8E^%^A8^%^E7^%^BF^%^BB^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^22^%^2C^%^221753930858744b5bz1pkk5^%^22:^%^22^%^E6^%^88^%^91^%^E8^%^A6^%^81^%^E6^%^8E^%^A8^%^E7^%^BF^%^BB^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^22^%^2C^%^221753931229186aygfxnuj6^%^22:^%^22^%^E6^%^88^%^91^%^E8^%^A6^%^81^%^E6^%^8E^%^A8^%^E7^%^BF^%^BB^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^EF^%^BC^%^81^%^22^%^2C^%^221753934111345lefs552k8^%^22:^%^22^%^E6^%^88^%^91^%^E6^%^83^%^B3^%^E5^%^AD^%^A6^%^E4^%^B9^%^A0^%^E4^%^B8^%^80^%^E4^%^B8^%^8B^%^E6^%^80^%^8E^%^E4^%^B9^%^88^%^E5^%^86^%^99^%^E4^%^BB^%^A5^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^E4^%^B8^%^BA^%^E4^%^B8^%^BB^%^E8^%^A7^%^92^%^E7^%^9A^%^84^%^E6^%^96^%^87^%^E7^%^AB^%^A0^%^22^%^2C^%^221753934769226wn976nks1^%^22:^%^22^%^E6^%^88^%^91^%^E6^%^83^%^B3^%^E5^%^AD^%^A6^%^E4^%^B9^%^A0^%^E4^%^B8^%^80^%^E4^%^B8^%^8B^%^E6^%^80^%^8E^%^E4^%^B9^%^88^%^E5^%^86^%^99^%^E4^%^BB^%^A5^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^E4^%^B8^%^BA^%^E4^%^B8^%^BB^%^E8^%^A7^%^92^%^E7^%^9A^%^84^%^E6^%^96^%^87^%^E7^%^AB^%^A0^%^22^%^2C^%^221753934975009j00r45c0s^%^22:^%^22^%^E6^%^88^%^91^%^E6^%^83^%^B3^%^E5^%^AD^%^A6^%^E4^%^B9^%^A0^%^E4^%^B8^%^80^%^E4^%^B8^%^8B^%^E6^%^80^%^8E^%^E4^%^B9^%^88^%^E4^%^BB^%^A5^%^E5^%^93^%^88^%^E5^%^9F^%^BA^%^E7^%^B1^%^B3^%^E4^%^B8^%^BA^%^E4^%^B8^%^BB^%^E8^%^A7^%^92^%^E6^%^9D^%^A5^%^E5^%^86^%^99^%^E4^%^B8^%^80^%^E9^%^A6^%^96^%^E6^%^95^%^A3...^%^22^%^2C^%^221753940334127a791bj67a^%^22:^%^22^%^E4^%^BD^%^A0^%^E5^%^8F^%^AF^%^E4^%^BB^%^A5^%^E4^%^B8^%^BA^%^E6^%^88^%^91^%^E6^%^8E^%^A8^%^E8^%^8D^%^90^%^E4^%^B8^%^80^%^E4^%^BA^%^9B^%^E5^%^86^%^99^%^E4^%^BD^%^9C^%^E7^%^9B^%^B8^%^E5^%^85^%^B3^%^E7^%^9A^%^84^%^E8^%^AF^%^BE^%^E7^%^A8^%^8B^%^E5^%^90^%^97^%^22^}^" ^
  -H ^"Origin: http://localhost:8234^" ^
  -H ^"Pragma: no-cache^" ^
  -H ^"Referer: http://localhost:8234/api/doc.html^" ^
  -H ^"Request-Origion: Knife4j^" ^
  -H ^"Sec-Fetch-Dest: empty^" ^
  -H ^"Sec-Fetch-Mode: cors^" ^
  -H ^"Sec-Fetch-Site: same-origin^" ^
  -H ^"User-Agent: Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Mobile Safari/537.36 Edg/138.0.0.0^" ^
  -H ^"sec-ch-ua: ^\^"Not)A;Brand^\^";v=^\^"8^\^", ^\^"Chromium^\^";v=^\^"138^\^", ^\^"Microsoft Edge^\^";v=^\^"138^\^"^" ^
  -H ^"sec-ch-ua-mobile: ?1^" ^
  -H ^"sec-ch-ua-platform: ^\^"Android^\^"^" ^
  --data-raw ^"^{^

  ^\^"initPrompt^\^": ^\^"^做^一^个^哈^基^米^博^客^，^总^代^码^行^数^不^超^过20^\^",^

  ^\^"codeGenType^\^": ^\^"HTML^\^",^

  ^\^"isVipOnly^\^": false^

^}^"

```
前端可能会有空格捕获问题，就是后端在进行流式输出的时候，前端可能会捕获不到空格，从而导致信息丢失
对返回的内容进行封装
```java
    /**
     * 应用聊天生成代码（流式 SSE）
     *
     * @param appId   应用 ID
     * @param message 用户消息
     * @param request 请求对象
     * @return 生成结果流
     */
    @GetMapping(value = "/chat/gen/code", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<ServerSentEvent<String>> chatToGenCode(@RequestParam Long appId,
                                               @RequestParam String message,
                                               HttpServletRequest request) {
        // 参数校验
        ThrowUtils.throwIf(appId == null || appId <= 0, ErrorCode.PARAMS_ERROR, "应用ID无效");
        ThrowUtils.throwIf(StrUtil.isBlank(message), ErrorCode.PARAMS_ERROR, "用户消息不能为空");
        // 获取当前登录用户
        User loginUser = userService.getLoginUser(request);
        // 调用服务生成代码（流式）
        Flux<String> stringFlux = appService.chatToGenCode(appId, message, loginUser);
        // 对这个流式结果进行一层封装，防止空格的丢失
        return stringFlux.map(chunk -> {
            //快速构造一个map
            Map<String, String> resultMap = Map.of("d",chunk);
            String jsonData = JSONUtil.toJsonStr(resultMap);
            return ServerSentEvent.<String>builder()
                    .data(jsonData)
                    .build();
                })
                //为前端提供一个done事件，使其区分是正常结束还是异常中断
                .concatWith(Mono.just(
                        ServerSentEvent.<String>builder()
                                .event("done") // 添加一个明确的done事件
                                .data("")
                                .build()
                ));
    }
```
在SSE中，当服务器关闭连接时，会触发客户端的onclose事件，这是前端判断流结束的标准方式。
但是，onclose事件会在连接正常结束（服务器主动关闭）和异常中断（如网络问题）时都触发，前端就很难区分到底后端是正常响应了所有数据、还是异常中断了。
因此，我们最好在后端添加一个明确的done事件，这样可以更清晰地区分流的正常结束和异常中断。

# 应用部署
部署的整体思路是：把本地生成的文件同步到一个Web服务器上。可以是同一个服务器的不同目录，也可以是不同服务器，但显然前者成本更低。

![image-20250804120940182](D:\ideaproject\mambo-ai-platform\assets\image-20250804120940182.png)

1.用serve

2.用springboot

```java
// 样板代码
@RestController
@RequestMapping("/static")
public class StaticResourceController {

    // 应用生成根目录（用于浏览）
    private static final String PREVIEW_ROOT_DIR = System.getProperty("user.dir") + "/tmp/code_output";

    /**
     * 提供静态资源访问，支持目录重定向
     * 访问格式：http://localhost:8123/api/static/{deployKey}[/{fileName}]
     */
    @GetMapping("/{deployKey}/**")
    public ResponseEntity<Resource> serveStaticResource(
            @PathVariable String deployKey,
            HttpServletRequest request) {
        try {
            // 获取资源路径
            String resourcePath = (String) request.getAttribute(HandlerMapping.PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE);
            resourcePath = resourcePath.substring(("/static/" + deployKey).length());
            // 如果是目录访问（不带斜杠），重定向到带斜杠的URL
            if (resourcePath.isEmpty()) {
                HttpHeaders headers = new HttpHeaders();
                headers.add("Location", request.getRequestURI() + "/");
                return new ResponseEntity<>(headers, HttpStatus.MOVED_PERMANENTLY);
            }
            // 默认返回 index.html
            if (resourcePath.equals("/")) {
                resourcePath = "/index.html";
            }
            // 构建文件路径
            String filePath = PREVIEW_ROOT_DIR + "/" + deployKey + resourcePath;
            File file = new File(filePath);
            // 检查文件是否存在
            if (!file.exists()) {
                return ResponseEntity.notFound().build();
            }
            // 返回文件资源
            Resource resource = new FileSystemResource(file);
            return ResponseEntity.ok()
                    .header("Content-Type", getContentTypeWithCharset(filePath))
                    .body(resource);
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
        }
    }

    /**
     * 根据文件扩展名返回带字符编码的 Content-Type
     */
    private String getContentTypeWithCharset(String filePath) {
        if (filePath.endsWith(".html")) return "text/html; charset=UTF-8";
        if (filePath.endsWith(".css")) return "text/css; charset=UTF-8";
        if (filePath.endsWith(".js")) return "application/javascript; charset=UTF-8";
        if (filePath.endsWith(".png")) return "image/png";
        if (filePath.endsWith(".jpg")) return "image/jpeg";
        return "application/octet-stream";
    }
}

```

![image-20250804123031610](D:\ideaproject\mambo-ai-platform\assets\image-20250804123031610.png)

先进行了重定向

3.使用nginx(推荐)

```
# 静态资源服务器 - 80 端口
server {
    listen       80;
    server_name  localhost;
    charset      utf-8;
    charset_types text/css application/javascript text/plain text/xml application/json;
    # 项目部署根目录
    root         D:/ideaproject/mambo-ai-platform/tmp/code_output;
    
    # 处理所有请求
    location ~ ^/([^/]+)/(.*)$ {
        try_files /$1/$2 /$1/index.html =404;
    }
}

```

混合方案：使用SpringBoot接口实现Al生成的网页预览，使用Nginx提供网站部署服务。

部署接口接受appld作为请求参数，返回可访问的URL地址${部署域名}/{deployKey}。
部署流程如下：
1.参数校验：比如是否存在App、用户是否有权限部署该应用（仅本人可以部署）
2.生成deployKey:之前设计库表时已经提到了deployKey的生成逻辑（6位大小写字母+数字)，还要注意不能跟已有的 key重复;此外，每个 app只生成一次deployKey，已有则不生成。
3.部署操作：本质是将code_output目录下的临时文件复制到code_deploy目录下，为了简化访问地址，直接将deployKey作为文件名。

deploykey为null的时候表示初次部署

注意@requestparam和@requestbody的两种形式
![image-20250804141132554](D:\ideaproject\mambo-ai-platform\assets\image-20250804141132554.png)

requestparam这里是不能用json格式的

json格式对应的应该是requestbody

`@RequestParam` 只能用于绑定**简单类型**（如 String、int、Long 等），不能直接绑定**复杂对象**。Spring 无法将请求参数自动转换为 `AppDeployRequest` 对象。

```java
    /**
     * 应用部署
     * @param appId
     * @param loginUser
     * @return
     */
    @Override
    public String deployApp(Long appId, User loginUser){
        // 1.参数校验
        if( appId == null || appId <= 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "应用 ID 不能为空");
        }
        if( loginUser == null || loginUser.getId() == null || loginUser.getId() <= 0) {
            throw new BusinessException(ErrorCode.NOT_LOGIN_ERROR, "用户未登录或登录信息不完整");
        }
        // 2.查询应用信息
        App app = this.getById(appId);
        ThrowUtils.throwIf(app == null, ErrorCode.NOT_FOUND_ERROR, "应用不存在");
        // 3.验证应用部署权限，只有本人才能部署应用
        if( !app.getUserId().equals(loginUser.getId())) {
            throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "无权限部署该应用");
        }
        // 4.验证应用是否为vip专属，并且检验用户是否为vip
        if ( app.getIsVipOnly() && !userService.isVip(loginUser)) {
            throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "该应用为 VIP 专属应用，请先开通 VIP");
        }
        // 5.检查是否有deploykey(6位大小写字母+数字),没有则生成
        String deployKey = app.getDeployKey();
        if (StrUtil.isBlank(deployKey)) {
            deployKey = RandomUtil.randomString(6);
        }
        // 6.获取代码生成类型，构建源目录路径
        String codeGenTypeStr = app.getCodeGenType();
        String sourceDirName = codeGenTypeStr + "_" + appId;
        String sourceDirPath = CODE_OUTPUT_ROOT_DIR + File.separator + sourceDirName; // 注意分割
        // 7.检查源目录是否存在
        File sourceDir = new File(sourceDirPath);
        if (!sourceDir.exists() || !sourceDir.isDirectory()) {
            throw new BusinessException(ErrorCode.NOT_FOUND_ERROR, "应用代码生成目录不存在，请先生成代码");
        }
        // 8.复制文件到部署目录
        String deployDirPath = CODE_DEPLOY_ROOT_DIR + File.separator + deployKey ;
        FileUtil.copyContent(sourceDir, new File(deployDirPath), true);
        // 9.更新应用的deploykey和部署时间
        App updateApp = new App();
        updateApp.setId(appId);
        updateApp.setDeployKey(deployKey);
        updateApp.setUpdateTime(LocalDateTime.now());
        // 调用保存
        this.updateById(updateApp);
        // 10.返回访问的url
        // 注意这里一定要带上/ 不然无法触发重定向
        return String.format("%s/%s/", CODE_DEPLOY_HOST, deployKey);
    }

```

浏览器在解析相对路径时，会根据当前 URL 的格式来判断它是**文件**还是**目录**：

- **文件格式：** `http://localhost/7GLzp6`（没有尾随斜杠）
- **目录格式：** `http://localhost/7GLzp6/`（有尾随斜杠）

在没有/的时候，系统会将其判断为文件名，那么经过处理过后，其基础路径会被处理为localhost/

```
当前 URL：http://localhost/7GLzp6
当前路径：/（根目录）
基础路径：http://localhost/

HTML 中的相对路径：
- style.css → http://localhost/ + style.css = http://localhost/style.css ❌
- script.js → http://localhost/ + script.js = http://localhost/script.js ❌
```

当有/的时候，系统会将其判断为目录，其基础路径就会被处理为localhost/7GLzp6/

```
当前 URL：http://localhost/7GLzp6/
当前路径：/7GLzp6/（当前目录）
基础路径：http://localhost/7GLzp6/

HTML 中的相对路径：
- style.css → http://localhost/7GLzp6/ + style.css = http://localhost/7GLzp6/style.css ✅
- script.js → http://localhost/7GLzp6/ + script.js = http://localhost/7GLzp6/script.js ✅
```

